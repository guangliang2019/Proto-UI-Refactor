# adapter-web-component / feedback.style.apply-to-host — 应用到宿主契约 (v0)

## 1. 目的

本契约定义了 Web Component 适配器如何消费从 feedback 导出的样式意图，并将其**应用到宿主元素**。

在 v0 中，适配器主要通过将 token 映射到**基于类的输出**来实现样式意图，由 Tailwind 作为运行时样式系统提供支持。

本契约不定义样式意图如何生成或合并。它只定义适配器在将样式意图应用到宿主时的职责和不变量。

---

## 2. 输入

### 2.1 样式意图输入

适配器通过 `feedback.style.export` 消费样式意图，概念上表示为：

```ts
{
  tokens: string[]
}
```

- `tokens` 是语义样式意图 token
- Token 源自 `def.feedback.style.use`
- Token 已经过语义合并

---

### 2.2 宿主元素

适配器将样式应用到**组件宿主元素**。

- 宿主元素是根交互表面
- 适配器不得假设对宿主类的独占所有权
- 宿主上预先存在的类必须被保留

---

## 3. 实现策略 (v0)

### 3.1 主要策略：类映射

在 v0 中，适配器应该通过将导出的 token 映射到**应用于宿主元素的类名**来实现样式意图。

- 每个 token 被视为类标识符
- Token 被添加到宿主的 `classList`
- Token 到类的映射默认基于身份

此策略与 Tailwind 的运行时模型对齐，并支持通过标准 CSS 进行下游自定义。

---

### 3.2 可选优化：CSS 变量

适配器可以选择引入 CSS 变量作为优化策略。

示例包括（非穷尽）：

- 减少类变动
- 启用主题级别的覆盖
- 提高运行时更新性能

此类优化必须保留 token 的语义含义，且不得改变可观察的行为。

CSS 变量的存在或不存在是实现细节，组件作者不得依赖于此。

---

## 4. 应用语义

### 4.1 初始应用

当组件挂载时，适配器必须将所有导出的 token 应用到宿主元素。

- Token 必须作为连贯集合应用
- 不允许部分应用

---

### 4.2 更新语义

尽管 v0 样式意图是静态的，适配器必须遵循以下规则以保持与未来扩展的兼容性：

- 重新应用样式意图不得在语义上重新排序 token
- 后续更新不得重新引入先前移除的 token
- 样式应用必须是幂等的

---

### 4.3 清理

当组件卸载或释放时：

- 适配器必须仅移除它应用的样式
- 预先存在的宿主类不得被移除或更改

清理必须精确且限定范围。

---

## 5. 调度和时序

### 5.1 调度责任

适配器负责选择样式意图何时应用。

Feedback 不规定调度。

---

### 5.2 时序约束 (v0)

适配器必须满足以下约束：

- **顺序保留**
  样式应用不得反转用户交互的相对顺序。

- **有界延迟**
  应用的样式必须在不晚于以下时间变得可观察：

  - 宿主的下一个渲染/提交周期，或
  - 下一个动画帧

允许立即应用，并视为合规。

---

### 5.3 宿主驱动的渲染

如果宿主环境控制渲染时序：

- 适配器可以延迟样式应用以与宿主调度对齐
- 此类延迟必须保持在上述定义的有界延迟内

---

## 6. 语义不变量

所有适配器实现必须保留以下不变量：

1. **语义等价性**
   实现的宿主样式必须反映导出 token 描述的相同语义意图。

2. **无隐式优先级注入**
   适配器不得引入超出语义合并所暗示的额外优先级或级联规则。

3. **宿主无关性**
   适配器不得依赖未记录的宿主行为或未定义的类排序语义。

---

## 7. 错误处理

适配器不得因样式应用而抛出错误，除非：

- 宿主元素不可用
- 内部不变量被违反

样式实现失败应在可能的情况下优雅降级。

---

## 8. 调试和合规性信号（可选）

适配器可以为调试目的暴露诊断信息，例如：

- 实现策略（`class-based`、`class+vars`）
- 应用时序（`immediate`、`next-frame`、`host-commit`）

此类信号仅用于诊断，不得影响语义。

---

## 9. 非目标

本契约明确不定义：

- Tailwind 如何配置或打包
- Token 如何编写
- 动态条件如何影响样式
- 多个适配器如何协调样式
- 用户定义的 CSS 覆盖如何编写

---

## 10. 相关契约

本契约消费：

- `feedback/style.export.v0`

并补充：

- `feedback/style.use.setup-only.v0`
- `feedback/style.merge.semantic.v0`

